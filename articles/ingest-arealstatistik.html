<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Ingest Swiss Arealstatistik LULC Data • evoland</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><script src="ingest-arealstatistik_files/libs/quarto-html/popper.min.js"></script><script src="ingest-arealstatistik_files/libs/quarto-html/tippy.umd.min.js"></script><link href="ingest-arealstatistik_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="ingest-arealstatistik_files/libs/quarto-html/light-border.css" rel="stylesheet">
<!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Ingest Swiss Arealstatistik LULC Data">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">evoland</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/ingest-arealstatistik.html">Ingest Swiss Arealstatistik LULC Data</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ethzplus/evoland-plus/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-quarto">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Ingest Swiss Arealstatistik LULC Data</h1>

      <p class="author">Jan Hartman</p>
      <p class="date">2025-10-16</p>

      <small class="dont-index">Source: <a href="https://github.com/ethzplus/evoland-plus/blob/main/vignettes/ingest-arealstatistik.qmd" class="external-link"><code>vignettes/ingest-arealstatistik.qmd</code></a></small>
      <div class="d-none name"><code></code></div>
    </div>






    <p>This file shows how to ingest <a href="https://www.bfs.admin.ch/bfs/de/home/dienstleistungen/geostat/geodaten-bundesstatistik/boden-nutzung-bedeckung-eignung/arealstatistik-schweiz.html" class="external-link">Arealstatistik (AS)</a> data into an evoland database.</p>
<p>In order to read in land use data, we first must create a database with the following metadata:</p>
<ul>
<li>
<strong>Configuration</strong> read from the sample configuration file</li>
<li>
<strong>Coordinates</strong> built from the configuration</li>
<li>
<strong>Periods</strong> built from the configuration</li>
<li>
<strong>LULC Metadata</strong> describing the land use/land cover classes we will use</li>
</ul>
<section class="level2"><h2 id="setup-ingest-config">Setup / Ingest Config<a class="anchor" aria-label="anchor" href="#setup-ingest-config"></a>
</h2>
<p>We retrieve the path of the <code>evoland</code> default configuration; for your own work, you would likely copy it to your working directory and adapt it. The database connection will only be closed once the db object is removed from the workspace and garbage collected (i.e. <code>rm(db); gc()</code>); this means there will be a lock on the database, even for reading!</p>
<p>Also, let’s make sure the provider is Arealstatistik. Because the AS is in EPSG:2056 and the sampling relies on a raw coordinate matrix without CRS info, let’s make sure we’re working in the same CRS.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ethzplus.github.io/evoland-plus">evoland</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># new database file. schema gets auto-applied.</span></span>
<span><span class="va">db</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/evoland_db.html">evoland_db</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>path <span class="op">=</span> <span class="st">"arealstatistik-model.duckdb"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># find default config, read into db and R object</span></span>
<span><span class="va">config_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"config.yaml"</span>, package <span class="op">=</span> <span class="st">"evoland"</span><span class="op">)</span></span>
<span><span class="va">db</span><span class="op">$</span><span class="va">config</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">config</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/evoland_config.html">read_evoland_config</a></span><span class="op">(</span><span class="va">config_path</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># would ideally not be necessary in this place</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span></span>
<span>  <span class="va">config</span><span class="op">$</span><span class="va">lulc_data</span><span class="op">$</span><span class="va">provider</span> <span class="op">==</span> <span class="st">"Arealstatistik"</span>,</span>
<span>  <span class="va">config</span><span class="op">$</span><span class="va">coords</span><span class="op">$</span><span class="va">epsg</span> <span class="op">==</span> <span class="fl">2056</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
</section><section class="level2"><h2 id="construct-coordinate-set">Construct Coordinate Set<a class="anchor" aria-label="anchor" href="#construct-coordinate-set"></a>
</h2>
<p>Now that we’ve read the configuration into the database, it’s time to construct a set of coordinate points. The essential part of the table that we’ll use later to build a correct sample of land use classes corresponding to the coordinate point IDs is also built.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">db</span><span class="op">$</span><span class="va">coords_t</span> <span class="op">&lt;-</span> <span class="fu">create_coords_t</span><span class="op">(</span><span class="va">config</span><span class="op">)</span></span>
<span><span class="va">minimal_coords_t</span> <span class="op">&lt;-</span> <span class="va">db</span><span class="op">$</span><span class="va">coords_t</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="va">id_coord</span>, <span class="va">lon</span>, <span class="va">lat</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
</div>
</section><section class="level2"><h2 id="retrieve-data">Retrieve Data<a class="anchor" aria-label="anchor" href="#retrieve-data"></a>
</h2>
<p>Let’s read the data sources referenced in the configuration and download them to the directory at <code>getOption("evoland.cachedir")</code>. This is read on package load from the <code>EVOLAND_CACHEDIR</code> environment variable, defaulting to <code>~/evoland-cache</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lulc_files</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/util_download.html">get_sources_dt</a></span><span class="op">(</span><span class="va">config</span><span class="op">)</span><span class="op">[</span><span class="va">conf_key</span> <span class="op">==</span> <span class="st">"lulc_data"</span><span class="op">]</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/util_download.html">download_and_verify</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Downloading: https://dam-api.bfs.admin.ch/hub/api/dam/assets/32376216/appendix</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">lulc_files</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1L</span><span class="op">)</span> <span class="co"># just making sure - this shouldn't be more than 1 file for AS</span></span>
<span><span class="va">zippath</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">getOption</a></span><span class="op">(</span><span class="st">"evoland.cachedir"</span><span class="op">)</span>,</span>
<span>  <span class="va">lulc_files</span><span class="op">$</span><span class="va">md5sum</span>,</span>
<span>  <span class="va">lulc_files</span><span class="op">$</span><span class="va">local_filename</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># find singular csv</span></span>
<span><span class="va">csv_file</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/unzip.html" class="external-link">unzip</a></span><span class="op">(</span><span class="va">zippath</span>, list <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/pluck.html" class="external-link">pluck</a></span><span class="op">(</span><span class="st">"Name"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">stringi</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/stringi/man/stri_subset.html" class="external-link">stri_subset_fixed</a></span><span class="op">(</span><span class="st">".csv"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">csv_file</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1L</span><span class="op">)</span></span></code></pre></div>
</div>
</section><section class="level2"><h2 id="read-data">Read Data<a class="anchor" aria-label="anchor" href="#read-data"></a>
</h2>
<p>Now that we have the file and know the name of the contained CSV file, let’s read it into a data.table. The columns matching with <code>AS[0-9]{2}_72</code> indicate the land use / land cover in one of the 72 classes of The columns starting with <code>FJ</code> indicate the flight year for each respective AS period.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">csv_con</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/connections.html" class="external-link">unz</a></span><span class="op">(</span><span class="va">zippath</span>, <span class="va">csv_file</span>, open <span class="op">=</span> <span class="st">"r"</span><span class="op">)</span></span>
<span><span class="va">arealstat_dt</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/readLines.html" class="external-link">readLines</a></span><span class="op">(</span><span class="va">csv_con</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/fread.html" class="external-link">fread</a></span><span class="op">(</span></span>
<span>    text <span class="op">=</span> <span class="va">_</span>,</span>
<span>    <span class="co"># selecting only years 1985-2018 for now; Arealstatistik 2025 is not yet finished</span></span>
<span>    select <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="st">"E_COORD"</span>,</span>
<span>      <span class="st">"N_COORD"</span>,</span>
<span>      <span class="st">"FJ85"</span>,</span>
<span>      <span class="st">"FJ97"</span>,</span>
<span>      <span class="st">"FJ09"</span>,</span>
<span>      <span class="st">"FJ18"</span>,</span>
<span>      <span class="co"># "FJ25",</span></span>
<span>      <span class="st">"AS85_72"</span>,</span>
<span>      <span class="st">"AS97_72"</span>,</span>
<span>      <span class="st">"AS09_72"</span>,</span>
<span>      <span class="st">"AS18_72"</span></span>
<span>      <span class="co"># "AS25_72"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/connections.html" class="external-link">close</a></span><span class="op">(</span><span class="va">csv_con</span><span class="op">)</span></span></code></pre></div>
</div>
</section><section class="level2"><h2 id="recode-lulc-classes">Recode LULC Classes<a class="anchor" aria-label="anchor" href="#recode-lulc-classes"></a>
</h2>
<p>The configuration file contains a section declaring the land use classes that are to be used in a simulation. Each class contains a <code>src_classes</code> field, which we’ll now make use of to recode the source material to our internal classification system.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># create lookup table to aggregate arealstatistik (AS) ids to id_lulc</span></span>
<span><span class="va">db</span><span class="op">$</span><span class="va">lulc_meta_t</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">create_lulc_meta_t</span><span class="op">(</span><span class="va">config</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lulc_meta_t</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">db</span><span class="op">$</span><span class="va">lulc_meta_t</span><span class="op">[</span>,</span>
<span>    <span class="co"># unnest list column</span></span>
<span>    <span class="fu">.</span><span class="op">(</span>AS <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">src_classes</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    by <span class="op">=</span> <span class="va">id_lulc</span></span>
<span>  <span class="op">]</span></span>
<span></span>
<span><span class="co"># longer form: arealstatistik replaced by id_lulc, flightyear</span></span>
<span><span class="va">lulc_fy_dt</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/melt.data.table.html" class="external-link">melt</a></span><span class="op">(</span></span>
<span>    <span class="co"># pivot longer with year from regex and coords as ID columns</span></span>
<span>    <span class="va">arealstat_dt</span>,</span>
<span>    id.vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"E_COORD"</span>, <span class="st">"N_COORD"</span><span class="op">)</span>,</span>
<span>    measure.vars <span class="op">=</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/measure.html" class="external-link">measure</a></span><span class="op">(</span></span>
<span>      <span class="va">value.name</span>, <span class="co"># first match group to columns</span></span>
<span>      year <span class="op">=</span> <span class="va">as.integer</span>, <span class="co"># second match group to single column</span></span>
<span>      pattern <span class="op">=</span> <span class="st">"(^FJ|AS)([0-9]{2})"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">[</span></span>
<span>    ,</span>
<span>    <span class="va">year</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">year</span> <span class="op">&gt;</span> <span class="fl">84L</span>, <span class="va">year</span> <span class="op">+</span> <span class="fl">1900L</span>, <span class="va">year</span> <span class="op">+</span> <span class="fl">2000L</span><span class="op">)</span></span>
<span>  <span class="op">]</span><span class="op">[</span></span>
<span>    <span class="va">lulc_meta_t</span>,</span>
<span>    <span class="fu">.</span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="va">E_COORD</span>,</span>
<span>      y <span class="op">=</span> <span class="va">N_COORD</span>,</span>
<span>      <span class="va">year</span>,</span>
<span>      flightyear <span class="op">=</span> <span class="va">FJ</span>,</span>
<span>      <span class="va">id_lulc</span></span>
<span>    <span class="op">)</span>,</span>
<span>    on <span class="op">=</span> <span class="st">"AS"</span>,</span>
<span>    nomatch <span class="op">=</span> <span class="cn">NULL</span></span>
<span>  <span class="op">]</span></span></code></pre></div>
</div>
</section><section class="level2"><h2 id="rasterize-and-sample">Rasterize and Sample<a class="anchor" aria-label="anchor" href="#rasterize-and-sample"></a>
</h2>
<p>We want to take advantage of the spatial structure of the data to extract the coordinate values of the Arealstatistik at the points where our coordinates are declared. Hence, we rasterize the tabular data into a multilayer <code><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">terra::rast</a></code> object.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># data.table that can be coerced to multilayer terra::rast using type = "xylz"</span></span>
<span><span class="va">layerized_dt</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/melt.data.table.html" class="external-link">melt</a></span><span class="op">(</span></span>
<span>    <span class="va">lulc_fy_dt</span>,</span>
<span>    id.vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"year"</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">[</span></span>
<span>    ,</span>
<span>    <span class="va">layer</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">variable</span>, sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span></span>
<span>  <span class="op">]</span></span>
<span><span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setkey.html" class="external-link">setkey</a></span><span class="op">(</span><span class="va">layerized_dt</span>, <span class="va">layer</span>, <span class="va">x</span>, <span class="va">y</span><span class="op">)</span></span>
<span></span>
<span><span class="va">r</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>    <span class="va">layerized_dt</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">layer</span>, <span class="va">value</span><span class="op">)</span><span class="op">]</span>,</span>
<span>    type <span class="op">=</span> <span class="st">"xylz"</span>,</span>
<span>    crs <span class="op">=</span> <span class="st">"EPSG:2056"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/is.bool.html" class="external-link">as.int</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># necessary because terra::rast casts to numeric?</span></span></code></pre></div>
</div>
<p>Now we have an ndarray with spatial properties, let’s use extract and some pivoting magic to coerce these data into a table with an <code>id_coord, id_lulc, date</code> tuple.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">id_coord_var_dt</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html" class="external-link">extract</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">r</span>,</span>
<span>    y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">minimal_coords_t</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="va">lon</span>, <span class="va">lat</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    method <span class="op">=</span> <span class="st">"simple"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>id_coord <span class="op">=</span> <span class="va">minimal_coords_t</span><span class="op">[[</span><span class="st">"id_coord"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/melt.data.table.html" class="external-link">melt</a></span><span class="op">(</span></span>
<span>    id.vars <span class="op">=</span> <span class="st">"id_coord"</span>,</span>
<span>    measure.vars <span class="op">=</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/measure.html" class="external-link">measure</a></span><span class="op">(</span></span>
<span>      year <span class="op">=</span> <span class="va">as.integer</span>,</span>
<span>      <span class="va">value.name</span>,</span>
<span>      pattern <span class="op">=</span> <span class="st">"([0-9]{4})_(.*)"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html" class="external-link">na.omit</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"id_lulc"</span>, <span class="st">"flightyear"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setattr.html" class="external-link">setnames</a></span><span class="op">(</span></span>
<span>    old <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"year"</span>, <span class="st">"flightyear"</span><span class="op">)</span>,</span>
<span>    new <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"period_date"</span>, <span class="st">"date"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
</div>
</section><section class="level2"><h2 id="associate-with-regular-periods">Associate with Regular Periods<a class="anchor" aria-label="anchor" href="#associate-with-regular-periods"></a>
</h2>
<p>Since our land use change model runs in discrete time and our original land use data may not be in a regular time series, we here associate each <code>id_coord, id_lulc</code> tuple with a regular discrete <code>id_period</code>, built from the <code>periods</code> section of the settings. For now, the join condition (left closed) is only codified here and in the wiki. Making this canonical will save future modellers headaches.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># setup transition periods</span></span>
<span><span class="va">db</span><span class="op">$</span><span class="va">periods_t</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">periods_t</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">create_periods_t</span><span class="op">(</span><span class="va">config</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># build date objects from years. use 1st of january</span></span>
<span><span class="va">id_coord_var_dt</span><span class="op">[</span></span>
<span>  ,</span>
<span>  <span class="fu">`:=`</span><span class="op">(</span></span>
<span>    period_date <span class="op">=</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/IDateTime.html" class="external-link">as.IDate</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">period_date</span>, <span class="st">"-01-01"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    date <span class="op">=</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/IDateTime.html" class="external-link">as.IDate</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">date</span>, <span class="st">"-01-01"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">]</span></span>
<span></span>
<span><span class="va">lulc_data_t</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/lulc_data_t.html">as_lulc_data_t</a></span><span class="op">(</span></span>
<span>    <span class="va">id_coord_var_dt</span><span class="op">[</span></span>
<span>      <span class="va">periods_t</span>,</span>
<span>      <span class="fu">.</span><span class="op">(</span></span>
<span>        <span class="va">id_coord</span>,</span>
<span>        <span class="va">id_lulc</span>,</span>
<span>        <span class="va">id_period</span>,</span>
<span>        <span class="va">date</span></span>
<span>      <span class="op">)</span>,</span>
<span>      on <span class="op">=</span> <span class="fu">.</span><span class="op">(</span></span>
<span>        <span class="co"># left closed interval</span></span>
<span>        <span class="va">period_date</span> <span class="op">&gt;=</span> <span class="va">start_date</span>,</span>
<span>        <span class="va">period_date</span> <span class="op">&lt;</span> <span class="va">end_date</span></span>
<span>      <span class="op">)</span>,</span>
<span>      nomatch <span class="op">=</span> <span class="cn">NULL</span></span>
<span>    <span class="op">]</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
</div>
</section><section class="level2"><h2 id="finalize-ingest">Finalize: Ingest<a class="anchor" aria-label="anchor" href="#finalize-ingest"></a>
</h2>
<p>Now that we have the data prepared and validated in the correct format, we upsert them into the database:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">db</span><span class="op">$</span><span class="va">lulc_data_t</span> <span class="op">&lt;-</span> <span class="va">lulc_data_t</span></span></code></pre></div>
</div>
</section><script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'light-border',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config);
    }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script></main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Jan Hartman.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
